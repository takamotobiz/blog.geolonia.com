---
layout: post
title: デプロイ速度が 10000倍に！ベクトルタイルの動的配信を完全サーバーレス化した話
background: /img/20201203/header.jpg
excerpt: Geolonia のベクトルタイル配信環境をアップデートし、ベクトルタイル開発のフローを効率化しました。
author: kamataryo
---

こんにちは！  
このポストでは、Geolonia のベクトルタイル配信基盤についての技術的な詳細を解説します。

AWS 環境上に構築された Gelonia のバックエンドは完全なサーバーレス構成になっています。従来はベクトルタイルのデータを静的にホスティングして配信していましたが、今回システムのリプレイスを行い、サーバーレスな構成を維持したままベクトルタイルを動的に配信できるようになりました。

## リプレイス前（静的配信）

タイルを静的配信する旧環境は Amazon S3、 及び CloudFront を用いた構成でした。  
ベクトルタイルを含むウェブ地図のタイルは (`z/x/y.mvt`)のようなパスで配信されていることが多いと思いますが、この zxy インデックスをキーとして S3 バケットのオブジェクトとして静的なファイルをホスティングしています。CloudFront からはこのバケットをオリジンとしてコンテンツ配信が行われます。

![static tiles](/img/20201203/010_static.png)

ユーザーからのタイルのリクエストがあると、CloudFront へのビューワリクエスト及びオリジンレスポンスに伴って Lambda@Edge が発火し、アクセストークンの検証やキャッシュ制御などを行います。

![lambda edge](/img/20201203/020_lambdaatedge.png)

Lambda@Edge としてデプロイする Lambda 関数の作成やインフラの構成管理については [Serverless Framework](https://www.serverless.com/) をインターフェースとして用いることで DevOps に親和的な開発環境を実現しています。

なお、Geolonia の API サーバーは 同様に全てサーバーレスな構成となっていて、またその全てがコードベースで管理され開発フローの自動化が行われています。

### 課題

S3 でのベクトルタイルホスティングにはいくつかの課題があります。  
まず、Lambda@Edge のデプロイフローが煩雑であること。Lambda@Edge を更新するために CloudFront ディストリビューションのデプロイが必要です。更新が完了するまで 10 数分ほどかかります。  
また、タイルのデータのデプロイはさらに大変で、例えば日本のエリアを対象に生成した全てのベクトルタイルをデプロイするには一週間近い時間がかかります。これは、HTTP で行われる `S3::putObject` の操作を大量のタイルのファイルに対して行う必要があるためです。

## リプレイス後（動的配信）

そこで、S3 と Lambda@Edge の利用をやめ、タイルのデータのデプロイは [MBTiles](https://wiki.openstreetmap.org/wiki/MBTiles) 形式のファイルの単位で行うことにし、デプロイにかかる時間の短縮をはかりました。
新しい構成は以下のようになっています。

![dynamic tiles](/img/20201203/030_dynamic.png)

新環境では、 MBTiles ファイルは直接 EFS に保存されます。MBTiles のファイルは SQLite 形式のデータベースで、zxy インデックスを指定してクエリを行うことでベクトルタイルデータが取得できます。  
EFS へのアクセスは同一の VPC 内部に配置した Lambda から行います。ユーザーからのタイルのリクエストがあると Lambda が発火し、アクセストークンの検証などの制御を経てタイルのデータが配信されます。

#### メリット

EFS を使うことでデプロイの速度が大幅に改善されました。
作業の負担が軽減され、デプロイ・検証・公開のサイクルを短縮したことで、フィードバックをダイレクトに反映しながら製品である地図タイルを改善していくワークフローが整いました。

データの出力時にコンテンツに対して動的な変更を加えることが可能になったのも魅力的です。例えばタイルをリクエストしたユーザーに応じて個別に最適化されたデータを配信することも可能になりました。

新しい配信方式のベクトルタイルの地図は [公式ドキュメント](https://docs.geolonia.com/tutorial/001/) などで体験していただくことができます。CodePen などを使い、好きなようにカスタマイズしながら Geolonia の地図を試すことが可能です。試していただく際に API キーは不要です。

また、現在 β 版の段階ですが、独自ドメインで Geolonia の地図を利用することができる API キーを発行するための[ダッシュボード](https://app.geolonia.com)も用意しています。

---

Geolonia ではクラウドや Node.js が好きな開発パートナーさんを募集しています。
ぜひ Geolonia の [Office Hour](https://calendly.com/geolonia/office-hour) に遊びに来てください。
お仕事のご相談やその他雑談も大歓迎です！
